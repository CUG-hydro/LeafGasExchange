<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Canopy_scaling • LeafGasExchange</title>
<!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js" integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin="anonymous"></script><!-- Bootstrap --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/css/bootstrap.min.css" integrity="sha256-bZLfwXAP04zRMK2BjiO8iu9pf4FbLqX6zitd+tIvLhE=" crossorigin="anonymous">
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/js/bootstrap.min.js" integrity="sha256-nuL8/2cJ5NDSSwnKD8VqreErSWHtnEP9E7AySL+1ev4=" crossorigin="anonymous"></script><!-- bootstrap-toc --><link rel="stylesheet" href="../bootstrap-toc.css">
<script src="../bootstrap-toc.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../pkgdown.js"></script><meta property="og:title" content="Canopy_scaling">
<meta property="og:description" content="LeafGasExchange">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body data-spy="scroll" data-target="#toc">
    

    <div class="container template-article">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">LeafGasExchange</a>
        <span class="version label label-default" data-toggle="tooltip" data-placement="bottom" title="">1.1.0</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="../reference/index.html">Reference</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" data-bs-toggle="dropdown" aria-expanded="false">
    Articles
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="../articles/Aci_fitting.html">Aci_fitting</a>
    </li>
    <li>
      <a href="../articles/Aq_fitting.html">Aq_fitting</a>
    </li>
    <li>
      <a href="../articles/Canopy_scaling.html">Canopy_scaling</a>
    </li>
    <li>
      <a href="../articles/Simulation_of_leaf_conductance.html">Guide to use the LeagGasExchange package to simulate leaf conductance</a>
    </li>
    <li>
      <a href="../articles/Simulation_of_leaf_photosynthesis.html">Guide to use the LeafGasExchange package to simulate the photosynthesis</a>
    </li>
  </ul>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right"></ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      

      </header><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header toc-ignore">
      <h1 data-toc-skip>Canopy_scaling</h1>
                        <h4 data-toc-skip class="author">Julien
LAMOUR</h4>
            
            <h4 data-toc-skip class="date">04/20/2023</h4>
      
      
      <div class="hidden name"><code>Canopy_scaling.Rmd</code></div>

    </div>

    
    
<div class="section level2">
<h2 id="canopy-scaling">Canopy Scaling<a class="anchor" aria-label="anchor" href="#canopy-scaling"></a>
</h2>
<p>The aim of this tutorial is to show how to scale the gas exchange
predictions from the leaf level to the canopy. In this tutorial, several
assumptions are used to simulate the canopy photosynthesis and
transpiration. We consider that apart from the light, the
micrometeorological variables are homogeneous inside the canopy (Air
temperature, CO2, humidity). We also consider that the leaf size and
structure is homogeneous. Those assumptions may be challenged if needed.
In this model we consider, as in most of the TBMs, that the vertical
gradients of leaf properties are similar for all the photosynthetic
parameters (Vcmax, Jmax, Tp and Td).</p>
<div class="section level3">
<h3 id="overall-description-of-the-canopy-scaling">Overall description of the canopy scaling<a class="anchor" aria-label="anchor" href="#overall-description-of-the-canopy-scaling"></a>
</h3>
<p>Basically, in most of the TBMs, the photosynthesis is modeled at the
leaf level and the scaling up to the canopy is made using two other
elements, the canopy structure and the canopy radiation
interception.</p>
<p>The leaf level photosynthesis is modeled using the function f.A. This
function allows to simulate the leaf gas exchange using input
environmental variables surrounding the leaves (Q, RH, Tair, Tleaf) and
the leaf photosynthetic parameters (produced using the function
f.make.param()). This function couples 2 different models: (i) The
Farquhar et al. 1980 model itself which describes the rate of
photosynthesis from the intracellular CO2 concentration, and (ii) the
conductance model, which calculates the intracellular CO2 from the leaf
surface CO2 and environmental factors that modify the conductance of the
stomata.</p>
<p>The canopy structure corresponds to the vertical organization of the
forest, the size of the leaves and their orientation. The vertical
gradients of leaf properties are also represented, and notably the
vertical structure of Vcmax, Jmax, TPU and Rd. For those
representations, different equations can be used, see for example Clark
et al. 2011, Lloyd et al. 2010 or Krinner et al. 2005.</p>
<p>The canopy radiation interception simulates the light levels that
each leaf receives inside the canopy. The light can be diffuse (shaded
leaves) or direct (sunlit leaves) depending on the position. The Norman
radiation interception model (Norman 1979) is implemented as described
in Bonan (2019).</p>
</div>
<div class="section level3">
<h3 id="simulation-of-the-canopy-structure">Simulation of the canopy structure<a class="anchor" aria-label="anchor" href="#simulation-of-the-canopy-structure"></a>
</h3>
<p>We first model the canopy structure, ie the leaf photosynthetic
gradients, the LAI and the total height of the canopy. We consider 20
vertical levels inside the canopy.</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Modeling of the LAI inside the 20 levels of the canopy, with a total LAI of 6.2</span></span>
<span><span class="va">LAItot</span> <span class="op">=</span> <span class="fl">6</span></span>
<span><span class="va">nlayers</span><span class="op">=</span><span class="fl">20</span></span>
<span><span class="va">dLAI</span><span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="fl">6</span><span class="op">/</span><span class="va">nlayers</span>,<span class="va">nlayers</span><span class="op">)</span></span>
<span><span class="va">LAI</span><span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/cumsum.html" class="external-link">cumsum</a></span><span class="op">(</span><span class="va">dLAI</span><span class="op">)</span><span class="op">-</span><span class="va">dLAI</span><span class="op">/</span><span class="fl">2</span> <span class="co"># LAI in the midle of each layer</span></span>
<span></span>
<span><span class="co"># Modeling of the vertical structure of the Vcmax at 25 deg C (see the help of the function)</span></span>
<span><span class="va">Vcmax</span><span class="op">=</span><span class="fu"><a href="../reference/f.VcmaxRef.LAI.html">f.VcmaxRef.LAI</a></span><span class="op">(</span>kn<span class="op">=</span><span class="fl">0.11</span>,LAI<span class="op">=</span><span class="va">LAI</span>,Vcmax0<span class="op">=</span><span class="fl">70</span><span class="op">)</span></span>
<span><span class="co"># As in most TBM we model the other photosynthetic parameter from Vcmax</span></span>
<span><span class="va">Jmax</span><span class="op">=</span><span class="fl">1.7</span><span class="op">*</span><span class="va">Vcmax</span>; <span class="va">Tp</span><span class="op">=</span><span class="fl">1</span><span class="op">/</span><span class="fl">5</span><span class="op">*</span><span class="va">Vcmax</span>; <span class="va">Rd</span><span class="op">=</span><span class="fl">0.03</span><span class="op">*</span><span class="va">Vcmax</span></span>
<span><span class="co"># We consider that all the other leaf traits described in f.make.param are not vertically structured</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="simulation-of-the-light-inside-the-canopy">Simulation of the light inside the canopy<a class="anchor" aria-label="anchor" href="#simulation-of-the-light-inside-the-canopy"></a>
</h3>
<p>We first model the meterological conditions of a 24 h day. It would
be better to have real weather data but for the sake of this example,
the simulated data will work as well. Here, we only model the evolution
of light during the day, all the other meterological variables are
considered constant which is of course a (bad) simplification.</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">## Simulation of the diurnal variation in irradiance using the function from Takenaka (1989) as used in Hirose and Werger (1987)</span></span>
<span><span class="va">PFD_noon</span><span class="op">=</span><span class="fl">2000</span></span>
<span><span class="va">time</span><span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq</a></span><span class="op">(</span><span class="fl">0</span>,<span class="fl">23</span>,<span class="fl">1</span><span class="op">)</span></span>
<span><span class="va">PFD</span><span class="op">=</span><span class="va">PFD_noon</span><span class="op">*</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Trig.html" class="external-link">sin</a></span><span class="op">(</span><span class="va">pi</span><span class="op">*</span><span class="op">(</span><span class="va">time</span><span class="op">-</span><span class="fl">6</span><span class="op">)</span><span class="op">/</span><span class="fl">12</span><span class="op">)</span><span class="op">)</span><span class="op">^</span><span class="fl">2</span></span>
<span><span class="va">PFD</span><span class="op">[</span><span class="va">time</span><span class="op">&lt;</span><span class="fl">6</span><span class="op">|</span><span class="va">time</span><span class="op">&gt;=</span><span class="fl">18</span><span class="op">]</span><span class="op">=</span><span class="fl">0</span></span>
<span></span>
<span><span class="co">## We assume that all the other variables are constant during the day for simplicity</span></span>
<span><span class="va">Tair</span><span class="op">=</span><span class="va">Tleaf</span><span class="op">=</span><span class="fl">25</span></span>
<span><span class="va">cs</span><span class="op">=</span><span class="fl">400</span></span>
<span><span class="va">RH</span><span class="op">=</span><span class="fl">80</span></span>
<span></span>
<span><span class="co">##Simulation of weather data</span></span>
<span><span class="va">meteo_hourly</span><span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span>time<span class="op">=</span><span class="va">time</span>,RH<span class="op">=</span><span class="va">RH</span>,Tair<span class="op">=</span><span class="va">Tair</span>,cs<span class="op">=</span><span class="va">cs</span>,PFD<span class="op">=</span><span class="va">PFD</span>,Tleaf<span class="op">=</span><span class="va">Tleaf</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span>x<span class="op">=</span><span class="va">meteo_hourly</span><span class="op">$</span><span class="va">time</span>,y<span class="op">=</span><span class="va">meteo_hourly</span><span class="op">$</span><span class="va">PFD</span>,xlab<span class="op">=</span><span class="st">'Time of the day'</span>,ylab<span class="op">=</span><span class="st">'PFD in micro mol m-2 s-1'</span><span class="op">)</span></span></code></pre></div>
<p><img src="Canopy_scaling_files/figure-html/unnamed-chunk-2-1.png" width="700"></p>
<p>We now represent the light levels inside the canopy during the day.
To summarize, the function calculates the sun angle on a position on the
earth and calculate the amount of diffuse light and direct light that
will be received by the top of the canopy. Then the Norman interception
model is used to calculate the light levels inside the canopy.</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">lat</span><span class="op">=</span><span class="fl">9.2801048</span></span>
<span><span class="va">t.d</span> <span class="op">=</span> <span class="fl">0</span><span class="op">:</span><span class="fl">23</span></span>
<span><span class="va">DOY</span> <span class="op">=</span> <span class="fl">60</span></span>
<span></span>
<span><span class="va">canopy</span><span class="op">=</span><span class="fu"><a href="../reference/f.canopy.interception.html">f.canopy.interception</a></span><span class="op">(</span>meteo_hourly<span class="op">=</span><span class="va">meteo_hourly</span>,lat <span class="op">=</span> <span class="va">lat</span>,DOY <span class="op">=</span> <span class="va">DOY</span>,nlayers <span class="op">=</span> <span class="va">nlayers</span>,dLAI <span class="op">=</span> <span class="va">dLAI</span>,LAI<span class="op">=</span><span class="va">LAI</span><span class="op">)</span></span></code></pre></div>
<p><img src="Canopy_scaling_files/figure-html/unnamed-chunk-3-1.png" width="700"></p>
<pre><code><span><span class="co">## [1] "Radiation model for a total LAI of  6"</span></span>
<span><span class="co">## [1] "Radiation model for a total LAI of  6"</span></span>
<span><span class="co">## [1] "Radiation model for a total LAI of  6"</span></span>
<span><span class="co">## [1] "Radiation model for a total LAI of  6"</span></span>
<span><span class="co">## [1] "Radiation model for a total LAI of  6"</span></span>
<span><span class="co">## [1] "Radiation model for a total LAI of  6"</span></span>
<span><span class="co">## [1] "Radiation model for a total LAI of  6"</span></span>
<span><span class="co">## [1] "Radiation model for a total LAI of  6"</span></span>
<span><span class="co">## [1] "Radiation model for a total LAI of  6"</span></span>
<span><span class="co">## [1] "Radiation model for a total LAI of  6"</span></span>
<span><span class="co">## [1] "Radiation model for a total LAI of  6"</span></span>
<span><span class="co">## [1] "Radiation model for a total LAI of  6"</span></span>
<span><span class="co">## [1] "Radiation model for a total LAI of  6"</span></span>
<span><span class="co">## [1] "Radiation model for a total LAI of  6"</span></span>
<span><span class="co">## [1] "Radiation model for a total LAI of  6"</span></span>
<span><span class="co">## [1] "Radiation model for a total LAI of  6"</span></span>
<span><span class="co">## [1] "Radiation model for a total LAI of  6"</span></span>
<span><span class="co">## [1] "Radiation model for a total LAI of  6"</span></span>
<span><span class="co">## [1] "Radiation model for a total LAI of  6"</span></span>
<span><span class="co">## [1] "Radiation model for a total LAI of  6"</span></span>
<span><span class="co">## [1] "Radiation model for a total LAI of  6"</span></span>
<span><span class="co">## [1] "Radiation model for a total LAI of  6"</span></span>
<span><span class="co">## [1] "Radiation model for a total LAI of  6"</span></span>
<span><span class="co">## [1] "Radiation model for a total LAI of  6"</span></span>
<span><span class="co">## [1] "Radiation model for a total LAI of  6"</span></span>
<span><span class="co">## [1] "Radiation model for a total LAI of  6"</span></span>
<span><span class="co">## [1] "Radiation model for a total LAI of  6"</span></span>
<span><span class="co">## [1] "Radiation model for a total LAI of  6"</span></span>
<span><span class="co">## [1] "Radiation model for a total LAI of  6"</span></span>
<span><span class="co">## [1] "Radiation model for a total LAI of  6"</span></span>
<span><span class="co">## [1] "Radiation model for a total LAI of  6"</span></span>
<span><span class="co">## [1] "Radiation model for a total LAI of  6"</span></span>
<span><span class="co">## [1] "Radiation model for a total LAI of  6"</span></span>
<span><span class="co">## [1] "Radiation model for a total LAI of  6"</span></span>
<span><span class="co">## [1] "Radiation model for a total LAI of  6"</span></span>
<span><span class="co">## [1] "Radiation model for a total LAI of  6"</span></span>
<span><span class="co">## [1] "Radiation model for a total LAI of  6"</span></span>
<span><span class="co">## [1] "Radiation model for a total LAI of  6"</span></span>
<span><span class="co">## [1] "Radiation model for a total LAI of  6"</span></span>
<span><span class="co">## [1] "Radiation model for a total LAI of  6"</span></span>
<span><span class="co">## [1] "Radiation model for a total LAI of  6"</span></span>
<span><span class="co">## [1] "Radiation model for a total LAI of  6"</span></span>
<span><span class="co">## [1] "Radiation model for a total LAI of  6"</span></span>
<span><span class="co">## [1] "Radiation model for a total LAI of  6"</span></span>
<span><span class="co">## [1] "Radiation model for a total LAI of  6"</span></span>
<span><span class="co">## [1] "Radiation model for a total LAI of  6"</span></span>
<span><span class="co">## [1] "Radiation model for a total LAI of  6"</span></span>
<span><span class="co">## [1] "Radiation model for a total LAI of  6"</span></span></code></pre>
<p><img src="Canopy_scaling_files/figure-html/unnamed-chunk-3-2.png" width="700"><img src="Canopy_scaling_files/figure-html/unnamed-chunk-3-3.png" width="700"><img src="Canopy_scaling_files/figure-html/unnamed-chunk-3-4.png" width="700"><img src="Canopy_scaling_files/figure-html/unnamed-chunk-3-5.png" width="700"><img src="Canopy_scaling_files/figure-html/unnamed-chunk-3-6.png" width="700"><img src="Canopy_scaling_files/figure-html/unnamed-chunk-3-7.png" width="700"><img src="Canopy_scaling_files/figure-html/unnamed-chunk-3-8.png" width="700"></p>
</div>
<div class="section level3">
<h3 id="simulation-of-the-gpp-without-leaf-energy-budget">Simulation of the GPP without leaf energy budget<a class="anchor" aria-label="anchor" href="#simulation-of-the-gpp-without-leaf-energy-budget"></a>
</h3>
<p>Finally, we calculate the GPP and transpiration of the canopy:</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">canopy_gasEx</span><span class="op">=</span><span class="fu"><a href="../reference/f.GPP.html">f.GPP</a></span><span class="op">(</span>meteo_hourly <span class="op">=</span><span class="va">meteo_hourly</span>,</span>
<span>                   Vcmax_Profile <span class="op">=</span> <span class="va">Vcmax</span>,Jmax_Profile <span class="op">=</span><span class="va">Jmax</span>, Rd_Profile <span class="op">=</span><span class="va">Rd</span> ,Tp_Profile <span class="op">=</span> <span class="va">Tp</span>,</span>
<span>                   g0_Profile <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="fl">0.02</span>,<span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">Vcmax</span><span class="op">)</span><span class="op">)</span>,g1_Profile <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="fl">4</span>,<span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">Vcmax</span><span class="op">)</span><span class="op">)</span>,</span>
<span>                   canopy<span class="op">=</span><span class="va">canopy</span>,gsmin <span class="op">=</span> <span class="fl">0.01</span><span class="op">)</span></span></code></pre></div>
<p><img src="Canopy_scaling_files/figure-html/unnamed-chunk-4-1.png" width="700"><img src="Canopy_scaling_files/figure-html/unnamed-chunk-4-2.png" width="700"></p>
<pre><code><span><span class="co">## [1] "GPP =  6396.01584264149 g CO2 m-2 Ground Y-1"</span></span>
<span><span class="co">## [1] "ET =  1165.0365897533 L H20 m-2 Ground Y-1"</span></span></code></pre>
</div>
<div class="section level3">
<h3 id="simulation-of-the-gpp-with-the-leaf-energy-budget">Simulation of the GPP with the leaf energy budget<a class="anchor" aria-label="anchor" href="#simulation-of-the-gpp-with-the-leaf-energy-budget"></a>
</h3>
<p>Most of the times, the leaf temperature or canopy temperature is
decoupled from the air temperature and the leaf temperature is unknown.
A leaf energy budget allows the leaf temperature to be predicted. In our
code, we use the Tealeaves package (Muir 2019) to implement the leaf
energy budget and to predict the leaf temperature. Several factors
modifies the leaf energy budget and we invite you to read the very
nicely written paper associated with the Tealeaves package (Muir 2019)
to understand them. The input radiation, the leaf conductance and the
boundary layer modifies the leaf temperature. To model the leaf gas
exchanges by taking into account the energy budget we use the fonction
f.AT which is implemented in the function f.GPPT and works similarly to
the function f.GPP that we just used.</p>
<p>In the canopy layer, the wind is considered to be stronger at the top
of the canopy than on the ground following the Buckley et al. (2014)
equation. The rest of the f.GPPT function works very similarly to the
f.GPP function. Be careful however, the calculation time is much higher
due to the time to compute the energy budget (several minutes for
predicting a canopy with 20 layers).</p>
<p>We first add a wind column in our meteo_hourly dataframe wich is
necessary for calculating the leaf temperature. For this example we
consider that the wind is constant temporally over the course of the day
and equal 2 m/s</p>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">meteo_hourly</span><span class="op">$</span><span class="va">wind</span><span class="op">=</span><span class="fl">2</span></span></code></pre></div>
<p>We then make the predictions using f.GPPT</p>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">canopy_gasExT</span><span class="op">=</span><span class="fu"><a href="../reference/f.GPPT.html">f.GPPT</a></span><span class="op">(</span>meteo_hourly <span class="op">=</span><span class="va">meteo_hourly</span>,</span>
<span>                   Vcmax_Profile <span class="op">=</span> <span class="va">Vcmax</span>,Jmax_Profile <span class="op">=</span><span class="va">Jmax</span>, Rd_Profile <span class="op">=</span><span class="va">Rd</span> ,Tp_Profile <span class="op">=</span> <span class="va">Tp</span>,</span>
<span>                   g0_Profile <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="fl">0.02</span>,<span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">Vcmax</span><span class="op">)</span><span class="op">)</span>,g1_Profile <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="fl">4</span>,<span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">Vcmax</span><span class="op">)</span><span class="op">)</span>,</span>
<span>                   canopy<span class="op">=</span><span class="va">canopy</span>,gsmin <span class="op">=</span> <span class="fl">0.01</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## [1] "Layer 1 of 20 layers"</span></span>
<span><span class="co">## [1] "Layer 2 of 20 layers"</span></span>
<span><span class="co">## [1] "Layer 3 of 20 layers"</span></span>
<span><span class="co">## [1] "Layer 4 of 20 layers"</span></span>
<span><span class="co">## [1] "Layer 5 of 20 layers"</span></span>
<span><span class="co">## [1] "Layer 6 of 20 layers"</span></span>
<span><span class="co">## [1] "Layer 7 of 20 layers"</span></span>
<span><span class="co">## [1] "Layer 8 of 20 layers"</span></span>
<span><span class="co">## [1] "Layer 9 of 20 layers"</span></span>
<span><span class="co">## [1] "Layer 10 of 20 layers"</span></span>
<span><span class="co">## [1] "Layer 11 of 20 layers"</span></span>
<span><span class="co">## [1] "Layer 12 of 20 layers"</span></span>
<span><span class="co">## [1] "Layer 13 of 20 layers"</span></span>
<span><span class="co">## [1] "Layer 14 of 20 layers"</span></span>
<span><span class="co">## [1] "Layer 15 of 20 layers"</span></span>
<span><span class="co">## [1] "Layer 16 of 20 layers"</span></span>
<span><span class="co">## [1] "Layer 17 of 20 layers"</span></span>
<span><span class="co">## [1] "Layer 18 of 20 layers"</span></span>
<span><span class="co">## [1] "Layer 19 of 20 layers"</span></span>
<span><span class="co">## [1] "Layer 20 of 20 layers"</span></span></code></pre>
<p><img src="Canopy_scaling_files/figure-html/unnamed-chunk-6-1.png" width="700"><img src="Canopy_scaling_files/figure-html/unnamed-chunk-6-2.png" width="700"><img src="Canopy_scaling_files/figure-html/unnamed-chunk-6-3.png" width="700"></p>
<pre><code><span><span class="co">## [1] "GPP =  5574.45193486157 g CO2 m-2 Ground Y-1"</span></span>
<span><span class="co">## [1] "ET =  1405.79150422933 L H20 m-2 Ground Y-1"</span></span></code></pre>
<p>By default three figures are produced which give the vertical and
temporal variation of gsw, An and Tleaf in the canopy. Other figures can
be produced using the outputs if needed.</p>
<p>For example, if we want to compute a figure with the CO2 at the leaf
surface:</p>
<div class="sourceCode" id="cb11"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">CO2_surface</span><span class="op">=</span><span class="op">(</span><span class="va">canopy_gasExT</span><span class="op">$</span><span class="va">cs_dir</span><span class="op">*</span><span class="va">canopy</span><span class="op">$</span><span class="va">f_sun</span><span class="op">+</span><span class="va">canopy_gasExT</span><span class="op">$</span><span class="va">cs_dif</span><span class="op">*</span><span class="op">(</span><span class="fl">1</span><span class="op">-</span><span class="va">canopy</span><span class="op">$</span><span class="va">f_sun</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">CO2_surface</span><span class="op">=</span><span class="fu"><a href="https://rdrr.io/pkg/reshape2/man/melt.html" class="external-link">melt</a></span><span class="op">(</span><span class="va">CO2_surface</span><span class="op">)</span></span>
<span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span>data<span class="op">=</span><span class="va">CO2_surface</span>,<span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>x<span class="op">=</span><span class="va">time</span>,y<span class="op">=</span><span class="va">Layer</span>,fill<span class="op">=</span><span class="va">value</span><span class="op">)</span><span class="op">)</span><span class="op">+</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_tile.html" class="external-link">geom_raster</a></span><span class="op">(</span><span class="op">)</span></span>
<span>     <span class="op">+</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_brewer.html" class="external-link">scale_fill_distiller</a></span><span class="op">(</span>palette <span class="op">=</span> <span class="st">"Spectral"</span>, direction <span class="op">=</span> <span class="op">-</span><span class="fl">1</span><span class="op">)</span> <span class="op">+</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_continuous.html" class="external-link">scale_y_reverse</a></span><span class="op">(</span><span class="op">)</span></span>
<span>     <span class="op">+</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">xlab</a></span><span class="op">(</span><span class="st">"Time in the day"</span><span class="op">)</span></span>
<span>     <span class="op">+</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">ylab</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste</a></span><span class="op">(</span><span class="st">"Vertical level (0= top,"</span>,<span class="va">nlayers</span>,<span class="st">" = ground)"</span><span class="op">)</span><span class="op">)</span></span>
<span>     <span class="op">+</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">labs</a></span><span class="op">(</span>fill<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/expression.html" class="external-link">expression</a></span><span class="op">(</span><span class="va">C</span><span class="op">[</span><span class="va">s</span><span class="op">]</span><span class="op">~</span><span class="op">(</span><span class="va">ppm</span><span class="op">)</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<p><img src="Canopy_scaling_files/figure-html/unnamed-chunk-7-1.png" width="700"></p>
<p>This calculation uses the proportion of leaves in the sun (f_sun) and
their associated CO2 (cs_dir) and the proportion of shaded leaves
(1-f_sun) with their associated CO2 (cs_dif).</p>
<p>We can do the same for the humidity at the leaf surface</p>
<div class="sourceCode" id="cb12"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">RH_surface</span><span class="op">=</span><span class="op">(</span><span class="va">canopy_gasExT</span><span class="op">$</span><span class="va">RHs_dir</span><span class="op">*</span><span class="va">canopy</span><span class="op">$</span><span class="va">f_sun</span><span class="op">+</span><span class="va">canopy_gasExT</span><span class="op">$</span><span class="va">RHs_dif</span><span class="op">*</span><span class="op">(</span><span class="fl">1</span><span class="op">-</span><span class="va">canopy</span><span class="op">$</span><span class="va">f_sun</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">RH_surface</span><span class="op">=</span><span class="fu"><a href="https://rdrr.io/pkg/reshape2/man/melt.html" class="external-link">melt</a></span><span class="op">(</span><span class="va">RH_surface</span><span class="op">)</span></span>
<span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span>data<span class="op">=</span><span class="va">RH_surface</span>,<span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>x<span class="op">=</span><span class="va">time</span>,y<span class="op">=</span><span class="va">Layer</span>,fill<span class="op">=</span><span class="va">value</span><span class="op">)</span><span class="op">)</span><span class="op">+</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_tile.html" class="external-link">geom_raster</a></span><span class="op">(</span><span class="op">)</span></span>
<span>     <span class="op">+</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_brewer.html" class="external-link">scale_fill_distiller</a></span><span class="op">(</span>palette <span class="op">=</span> <span class="st">"Spectral"</span>, direction <span class="op">=</span> <span class="op">-</span><span class="fl">1</span><span class="op">)</span> <span class="op">+</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_continuous.html" class="external-link">scale_y_reverse</a></span><span class="op">(</span><span class="op">)</span></span>
<span>     <span class="op">+</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">xlab</a></span><span class="op">(</span><span class="st">"Time in the day"</span><span class="op">)</span></span>
<span>     <span class="op">+</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">ylab</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste</a></span><span class="op">(</span><span class="st">"Vertical level (0= top,"</span>,<span class="va">nlayers</span>,<span class="st">" = ground)"</span><span class="op">)</span><span class="op">)</span></span>
<span>     <span class="op">+</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">labs</a></span><span class="op">(</span>fill<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/expression.html" class="external-link">expression</a></span><span class="op">(</span><span class="va">RH</span><span class="op">[</span><span class="va">s</span><span class="op">]</span><span class="op">~</span><span class="op">(</span><span class="st">'%'</span><span class="op">)</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<p><img src="Canopy_scaling_files/figure-html/unnamed-chunk-8-1.png" width="700"></p>
<p>If you are interested in the temperature of the sun leaves or shaded
leaves:</p>
<div class="sourceCode" id="cb13"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">Tleaf_sun</span><span class="op">=</span><span class="va">canopy_gasExT</span><span class="op">$</span><span class="va">Tleaf_dir</span></span>
<span><span class="va">Tleaf_sun</span><span class="op">=</span><span class="fu"><a href="https://rdrr.io/pkg/reshape2/man/melt.html" class="external-link">melt</a></span><span class="op">(</span><span class="va">Tleaf_sun</span><span class="op">)</span></span>
<span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span>data<span class="op">=</span><span class="va">Tleaf_sun</span>,<span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>x<span class="op">=</span><span class="va">time</span>,y<span class="op">=</span><span class="va">Layer</span>,fill<span class="op">=</span><span class="va">value</span><span class="op">)</span><span class="op">)</span><span class="op">+</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_tile.html" class="external-link">geom_raster</a></span><span class="op">(</span><span class="op">)</span></span>
<span>     <span class="op">+</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_brewer.html" class="external-link">scale_fill_distiller</a></span><span class="op">(</span>palette <span class="op">=</span> <span class="st">"Spectral"</span>, direction <span class="op">=</span> <span class="op">-</span><span class="fl">1</span><span class="op">)</span> <span class="op">+</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_continuous.html" class="external-link">scale_y_reverse</a></span><span class="op">(</span><span class="op">)</span></span>
<span>     <span class="op">+</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">xlab</a></span><span class="op">(</span><span class="st">"Time in the day"</span><span class="op">)</span></span>
<span>     <span class="op">+</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">ylab</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste</a></span><span class="op">(</span><span class="st">"Vertical level (0= top,"</span>,<span class="va">nlayers</span>,<span class="st">" = ground)"</span><span class="op">)</span><span class="op">)</span></span>
<span>     <span class="op">+</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">labs</a></span><span class="op">(</span>fill<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/expression.html" class="external-link">expression</a></span><span class="op">(</span><span class="cn">T</span><span class="op">[</span><span class="va">leaf</span><span class="op">]</span><span class="op">~</span><span class="va">sun</span><span class="op">~</span><span class="op">(</span><span class="st">'K'</span><span class="op">)</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<p><img src="Canopy_scaling_files/figure-html/unnamed-chunk-9-1.png" width="700"></p>
<div class="sourceCode" id="cb14"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">Tleaf_shade</span><span class="op">=</span><span class="va">canopy_gasExT</span><span class="op">$</span><span class="va">Tleaf_dif</span></span>
<span><span class="va">Tleaf_shade</span><span class="op">=</span><span class="fu"><a href="https://rdrr.io/pkg/reshape2/man/melt.html" class="external-link">melt</a></span><span class="op">(</span><span class="va">Tleaf_shade</span><span class="op">)</span></span>
<span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span>data<span class="op">=</span><span class="va">Tleaf_shade</span>,<span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>x<span class="op">=</span><span class="va">time</span>,y<span class="op">=</span><span class="va">Layer</span>,fill<span class="op">=</span><span class="va">value</span><span class="op">)</span><span class="op">)</span><span class="op">+</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_tile.html" class="external-link">geom_raster</a></span><span class="op">(</span><span class="op">)</span></span>
<span>     <span class="op">+</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_brewer.html" class="external-link">scale_fill_distiller</a></span><span class="op">(</span>palette <span class="op">=</span> <span class="st">"Spectral"</span>, direction <span class="op">=</span> <span class="op">-</span><span class="fl">1</span><span class="op">)</span> <span class="op">+</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_continuous.html" class="external-link">scale_y_reverse</a></span><span class="op">(</span><span class="op">)</span></span>
<span>     <span class="op">+</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">xlab</a></span><span class="op">(</span><span class="st">"Time in the day"</span><span class="op">)</span></span>
<span>     <span class="op">+</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">ylab</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste</a></span><span class="op">(</span><span class="st">"Vertical level (0= top,"</span>,<span class="va">nlayers</span>,<span class="st">" = ground)"</span><span class="op">)</span><span class="op">)</span></span>
<span>     <span class="op">+</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">labs</a></span><span class="op">(</span>fill<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/expression.html" class="external-link">expression</a></span><span class="op">(</span><span class="cn">T</span><span class="op">[</span><span class="va">leaf</span><span class="op">]</span><span class="op">~</span><span class="va">shade</span><span class="op">~</span><span class="op">(</span><span class="st">'K'</span><span class="op">)</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<p><img src="Canopy_scaling_files/figure-html/unnamed-chunk-9-2.png" width="700"></p>
<p>Note that the fraction of sun leaves in the undercanopy is very low,
as well as the fraction of shaded leaves in the top of the canopy. Note
also that the ‘sun’ leaves show high temperature in the understory. This
is because the conductance is lower, therefore not cooling the leaf, due
to low Vcmax and A. The wind is also very low, making the leaf heat.
However, the proportion of leaves that are in direct sun in the
understory is very low, that’s why, overall, the mean temperature of the
leaves is higher in the top layer than on the bottom layer (see previous
output of the f.GPPT function)</p>
</div>
<div class="section level3">
<h3 id="references">References<a class="anchor" aria-label="anchor" href="#references"></a>
</h3>
<p>Bonan, G. (2019). Climate change and terrestrial ecosystem modeling.
Cambridge University Press.</p>
<p>Buckley, T. N., Martorell, S., Diaz‐Espejo, A., Tomàs, M., &amp;
Medrano, H. (2014). Is stomatal conductance optimized over both time and
space in plant crowns? A field test in grapevine (V itis vinifera).
Plant, Cell &amp; Environment, 37(12), 2707-2721.</p>
<p>Clark, D. B., Mercado, L. M., Sitch, S., Jones, C. D., Gedney, N.,
Best, M. J., . Cox, P. M. (2011). The Joint UK Land Environment
Simulator (JULES), model description - Part 2: Carbon fluxes and
vegetation dynamics. Geoscientific Model Development, 4(3), 701-722. <a href="doi:10.5194/gmd-4-701-2011" class="uri">doi:10.5194/gmd-4-701-2011</a></p>
<p>Farquhar, G.D., von Caemmerer, S. &amp; Berry, J.A. A biochemical
model of photosynthetic CO2 assimilation in leaves of C3 species. Planta
149, 78–90 (1980).</p>
<p>Hirose, T., &amp; Werger, M. J. A. (1987). Maximizing daily canopy
photosynthesis with respect to the leaf nitrogen allocation pattern in
the canopy. Oecologia, 72(4), 520-526.</p>
<p>Krinner, G., Viovy, N., de Noblet-Ducoudr?, N., Og?e, J., Polcher,
J., Friedlingstein, P., . Prentice, I. C. (2005). A dynamic global
vegetation model for studies of the coupled atmosphere-biosphere system.
Global Biogeochemical Cycles, 19(1). <a href="doi:10.1029/2003gb002199" class="uri">doi:10.1029/2003gb002199</a></p>
<p>Lloyd, J., Pati?o, S., Paiva, R. Q., Nardoto, G. B., Quesada, C. A.,
Santos, A. J. B., . Mercado, L. M. (2010). Optimisation of
photosynthetic carbon gain and within-canopy gradients of associated
foliar traits for Amazon forest trees. Biogeosciences, 7(6), 1833-1859.
<a href="doi:10.5194/bg-7-1833-2010" class="uri">doi:10.5194/bg-7-1833-2010</a></p>
<p>Muir, C. D., tealeaves: an R package for modelling leaf temperature
using energy budgets, AoB PLANTS, Volume 11, Issue 6, December 2019,
plz054</p>
<p>Norman, J. M. (1979). Modeling the complete crop canopy. ln: Barﬁeld,
G. Modification of the Aerial Environment of Crops. American Society of
Agricultural Engineers, 249, 280.</p>
<p>Takenaka, A. (1986). Studies on the forest light environment and the
ecological significance of light-response characteristics of leaf
photosynthesis. Dr Thesis, University of Tokyo</p>
</div>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="pkgdown-sidebar">

        <nav id="toc" data-toggle="toc"><h2 data-toc-skip>Contents</h2>
    </nav>
</div>

</div>



      <footer><div class="copyright">
  <p></p>
<p>Developed by Julien Lamour.</p>
</div>

<div class="pkgdown">
  <p></p>
<p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.0.7.</p>
</div>

      </footer>
</div>

  


  

  </body>
</html>
