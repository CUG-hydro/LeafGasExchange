---
title: "Canopy_scaling"
author: "Julien LAMOUR"
date: "10/16/2020"
output: github_document
---

```{r setup, include=FALSE}

knitr::opts_chunk$set(echo = TRUE)
library(LeafGasExchange)
```

# Canopy Scaling


The aim of this tutorial is to show how to scale the gas exchange predictions from the leaf to the canopy. In this tutorial, several assumptions are used to simulate the canopy photosynthesis (GPP) and the transpiration. We consider that apart from the light, the micrometeorological variables are homogeneous inside the canopy (Air temperature, wind, CO2, humidity). We also consider that the leaf size and structure is homogeneous. Those assumptions may be challenged if needed. In this model we consider, as in most of the TBMs, that the vertical gradients of leaf properties are similar for all the photosynthetic parameters (Vcmax, Jmax, Tp and Td).

## Overall description of the canopy scaling

Basically, in most of the TBMs, the photosynthesis is modeled at the leaf level and the scaling up to the canopy is made using two other elements, the canopy structure and the canopy radiation interception.

The leaf level photosynthesis is modeled using the function f.AT. This function allows to simulate the leaf gas exchange using input environmental variables surrounding the leaves (PARi, wind, RH, Tair) and leaf photosynthetic parameters (produced using the function f.make.param()). This function couples 3 different models. The Farquhar et al. 1980 model itself which describes the rate of photosynthesis from the intracellular CO2, the leaf temperature and the light intensity (PARi). Another model is the conductance model, which calculates the intracellular CO2 from the leaf surface CO2 and environmental factors that modify the conductance of the stomata. The last part of this model is the leaf energy budget which calculates the leaf temperature knowing the amount of energy that is received by the leaf and absorbed or reemmited. This part is represented by using the package tealeaves (Muir 2019)

The canopy structure corresponds to the vertical organization of the forest as well as its size, the size of the leaves, and their orientation. The vertical gradients of leaf properties are also represented, and notably the vertical structure of Vcmax, Jmax, TPU and Rd. For those representations, different equations can be used, see for example Clark et al. 2011, Lloyd et al. 2010 or Krinner et al. 2005. The main function describing the canopy structure are obtained from the package BioCro (https://github.com/ebimodeling/biocro). 

The canopy radiation interception simulates the light levels that each leaf receive inside the canopy. The light can be diffuse (shade leaf) or direct (sunlit leaf) depending on the position. This time again, the function from the package BioCro are used to describe the canopy radiation interception.


## Simulation of the canopy structure

We first model the canopy structure, ie the leaf photosynthetic gradients, the LAI and the total height of the canopy. We consider 50 vertical levels inside the canopy.

```{r}
# Modeling of the LAI inside the 50 levels of the canopy, with a total LAI of 6.2
Height = 26
LAItot = 6
n_layers=50
LAI=seq(0,LAItot,LAItot/(n_layers-1))

# Modeling of the vertical structure of the Vcmax at 25 deg C (see the help of the function)
Vcmax=f.VcmaxRef.LAI(kn=0.11,LAI=LAI,Vcmax0=70)
# As in most TBM we model the other photosynthetic parameter from Vcmax
Jmax=1.7*Vcmax; Tp=1/5*Vcmax; Rd=0.03*Vcmax
# We consider that all the other leaf traits described in f.make.param are not vertically structured
```


## Simulation of the light inside the canopy

We first model the meterological conditions of a 24 h day. It would be better to have real weather data but for the sake of this example, the simulated data will work as well. Here, we only model the evolution of light during the day, all the other meterological variables are considered constant which is of course a (bad) simplification. 


```{r}
##Simulation of weather data
meteo_hourly=data.frame(time=0:23,rh=80,at=25,sr=dnorm(x = seq(0,23,1),mean = 12,sd = 2.5)/0.16*2000,tl=25)
plot(x=meteo_hourly$time,y=meteo_hourly$sr,xlab='Time of the day',ylab='PPFD in micro mol m-2 s-1')

```


We now represent the light levels inside the canopy. The function is a wrapper of sunML and lightME functions from BioCro. We encourage you to go see the help of those functions. To summarize, they calculate the sun angle on a position on the earth to calculate the amount of diffuse light and direct light that will be received by the top of the canopy. Then a two stream radiation interception model is used to calculate the light levels inside the cnaopy.

```{r}
lat=9.2801048
t.d = 0:23
DOY = 60

canopy=f.canopy.interception(meteo_hourly=meteo_hourly,lat = lat,t.d = t.d,DOY = DOY,n_layers = n_layers,Height = Height,LAItot = LAItot)

```

## Simulation of the GPP without leaf energy budget

Finally, we calculate the GPP and transpiration of the canopy:

```{r}
canopy_gasEx=f.GPP(TBM = "FATES",meteo_hourly =meteo_hourly,
                   Vcmax_Profile = Vcmax,Jmax_Profile =Jmax, Rd_Profile =Rd ,Tp_Profile = Tp,
                   g0_Profile = rep(0.02,length(Vcmax)),g1_Profile = rep(4,length(Vcmax)),
                   canopy=canopy,gsmin = 0.01)
```


As you probably noticed, in this simulation the temperature of the vegetation was known as it is sometimes measured. It is also possible to use a leaf energy budget to estimate the vegetation temperature. The function to perform this simulation is f.GPPT. This function is more calculation intensive, so be patient..


```{r}
canopy_gasEx=f.GPPT(TBM = "FATES",meteo_hourly =meteo_hourly,
                   Vcmax_Profile = Vcmax,Jmax_Profile =Jmax, Rd_Profile =Rd ,Tp_Profile = Tp,
                   g0_Profile = rep(0.02,length(Vcmax)),g1_Profile = rep(4,length(Vcmax)),
                   canopy=canopy,gsmin = 0.01,wind=2)
```

```{r}

LAItot=6
Height=26
lat=9.2801048
t.d = 0:23
DOY = 60

meteo_hourly=data.frame(time=0:23,rh=80,at=25,sr=dnorm(x = seq(0,23,1),mean = 12,sd = 2.5)/0.16*2000,tl=25)

GPP_pack=GPP_new=rep(NA,50)
for(n_layers in 1:50){
LAI2=seq(0,LAItot,LAItot/(n_layers-1))
# Modeling of the vertical structure of the Vcmax at 25 deg C (see the help of the function)
Vcmax_layer=f.VcmaxRef.LAI(kn=0.11,LAI=LAI2,Vcmax0=70)
# As in most TBM we model the other photosynthetic parameter from Vcmax
Jmax_layer=1.7*Vcmax_layer; Tp_layer=1/5*Vcmax_layer; Rd_layer=0.03*Vcmax_layer


canopy2=f.canopy.interception(meteo_hourly=meteo_hourly,lat = lat,t.d = t.d,DOY = DOY,n_layers = n_layers,Height = Height,LAI = LAItot)

canopy_gasEx2=f.GPP(TBM = "FATES",meteo_hourly =meteo_hourly,
                   Vcmax_Profile = Vcmax_layer,Jmax_Profile =Jmax_layer, Rd_Profile =Rd_layer ,Tp_Profile = Tp_layer,
                   g0_Profile = rep(0.02,length(Vcmax_layer)),g1_Profile = rep(4,length(Vcmax_layer)),
                   canopy=canopy2,gsmin = -10)

g0=0.02
g1=4
cs=400
RH=80
Tleaf=273.15+25
Tair=273.15+25
A_tot=matrix(NA,nrow=n_layers,ncol=24)
for(time in 1:24){
  for (layer in 1:n_layers){
    Vcmax=Vcmax_layer[layer]
    Jmax=Jmax_layer[layer]
    Rd=Rd_layer[layer]
    Tp=Tp_layer[layer]
    Leaf_shade=LAItot/n_layers*canopy2$f_shade[layer,time]
    Leaf_sun=LAItot/n_layers*canopy2$f_sun[layer,time]
    PFD_shade=canopy2$canopy_time_dif[layer,time]
    PFD_sun=canopy2$canopy_time_dir[layer,time]
    A_shade_rate=f.A(PFD = PFD_shade,cs = cs,Tleaf = Tleaf,Tair = Tair,RH = RH,param = f.make.param(VcmaxRef = Vcmax,JmaxRef = Jmax,RdRef = Rd,TpRef = Tp,g0=g0,g1=g1))$A
     A_sun_rate=f.A(PFD = PFD_sun,cs = cs,Tleaf = Tleaf,Tair = Tair,RH = RH,param = f.make.param(VcmaxRef = Vcmax,JmaxRef = Jmax,RdRef = Rd,TpRef = Tp,g0=g0,g1=g1))$A
    A_shade=Leaf_shade*A_shade_rate*3600
    A_sun=Leaf_sun*A_sun_rate*3600
    A_tot[layer,time]=A_shade+A_sun
  }
}
GPP_day=sum(A_tot)
GPP_year=GPP_day*365
GPP_mol_year=GPP_year/1000000
GPP_g_year=GPP_mol_year*44
print(GPP_g_year)
print(canopy_gasEx2$GPP)
GPP_new[layer]=GPP_g_year
GPP_pack[layer]=canopy_gasEx2$GPP
}

```


## References

Clark, D. B., Mercado, L. M., Sitch, S., Jones, C. D., Gedney, N., Best, M. J., . Cox, P. M. (2011). The Joint UK Land Environment Simulator (JULES), model description - Part 2: Carbon fluxes and vegetation dynamics. Geoscientific Model Development, 4(3), 701-722. doi:10.5194/gmd-4-701-2011

Farquhar, G.D., von Caemmerer, S. & Berry, J.A. A biochemical model of photosynthetic CO2 assimilation in leaves of C3 species. Planta 149, 78â€“90 (1980).

Krinner, G., Viovy, N., de Noblet-Ducoudr?, N., Og?e, J., Polcher, J., Friedlingstein, P., . Prentice, I. C. (2005). A dynamic global vegetation model for studies of the coupled atmosphere-biosphere system. Global Biogeochemical Cycles, 19(1). doi:10.1029/2003gb002199

Lloyd, J., Pati?o, S., Paiva, R. Q., Nardoto, G. B., Quesada, C. A., Santos, A. J. B., . Mercado, L. M. (2010). Optimisation of photosynthetic carbon gain and within-canopy gradients of associated foliar traits for Amazon forest trees. Biogeosciences, 7(6), 1833-1859. doi:10.5194/bg-7-1833-2010

Muir, C. D., tealeaves: an R package for modelling leaf temperature using energy budgets, AoB PLANTS, Volume 11, Issue 6, December 2019, plz054







